<form th:action="@{/shift/generate/request/save}" th:object="${form}" method="post">
    <!-- hidden inputs -->
    <input type="hidden" th:field="*{department}" th:value="${department}" />
    <input type="hidden" th:field="*{targetMonth}" th:value="${month}" />

    <!-- hidden shiftRequests[] container -->
    <div id="request-fields"></div>

    <!-- è¡¨å½¢å¼ -->
    <table id="shift-table">
        <thead>
            <tr>
                <th>è·å“¡å</th>
                <th th:each="date : ${dateList}" th:text="${#temporals.format(date, 'M/d')}"></th>
            </tr>
        </thead>
        <tbody>
            <tr th:each="user, uStat : ${users}">
                <td th:text="${user.lastName + ' ' + user.firstName}"></td>
                <td th:each="date, dStat : ${dateList}"
                    class="cell"
                    th:attr="data-user-id=${user.id},data-date=${date}">
                </td>
            </tr>
        </tbody>
    </table>

    <br>
    <button type="submit" onclick="prepareFormData()">ä¿å­˜</button>
</form>

<!-- JSéƒ¨åˆ† -->
<script>
    let currentMode = 'normal';

    function setMode(mode) {
        currentMode = mode;
    }

    document.addEventListener("DOMContentLoaded", () => {
        document.querySelectorAll(".cell").forEach(cell => {
            cell.addEventListener("click", () => {
                if (currentMode === "request") toggleRequest(cell);
                else if (currentMode === "temporary") toggleTemporary(cell);
            });
        });
    });

    function toggleRequest(cell) {
        const v = cell.innerText;
        cell.innerText = v === "ä¼‘" ? "æœ‰" : v === "æœ‰" ? "" : "ä¼‘";
        updateClass(cell);
    }

    function toggleTemporary(cell) {
        const v = cell.innerText;
        cell.innerText = v === "è‡¨" ? "" : "è‡¨";
        updateClass(cell);
    }

    function updateClass(cell) {
        cell.classList.remove("ä¼‘", "æœ‰", "è‡¨");
        if (cell.innerText) cell.classList.add(cell.innerText);
    }

    // ğŸ”½ submitæ™‚ã« hidden input ã‚’æ§‹ç¯‰ã—ã¦ãƒ•ã‚©ãƒ¼ãƒ é€ä¿¡ã«å«ã‚ã‚‹
    function prepareFormData() {
        const container = document.getElementById("request-fields");
        container.innerHTML = ""; // ä¸€åº¦ãƒªã‚»ãƒƒãƒˆ

        let index = 0;
        document.querySelectorAll(".cell").forEach(cell => {
            const type = cell.innerText;
            if (!["ä¼‘", "æœ‰"].includes(type)) return;

            const userId = cell.dataset.userId;
            const date = cell.dataset.date;
            const department = document.querySelector('input[name="department"]').value;

            container.innerHTML += `
                <input type="hidden" name="shiftRequests[${index}].userId" value="${userId}" />
                <input type="hidden" name="shiftRequests[${index}].date" value="${date}" />
                <input type="hidden" name="shiftRequests[${index}].requestType" value="${type}" />
                <input type="hidden" name="shiftRequests[${index}].department" value="${department}" />
            `;
            index++;
        });
    }
</script>
